---
title: "R - Practice 01"
author: Sangkon Han(sangkon@pusan.ac.kr)
date: "`r format(Sys.Date())`" 
output:
  pdf_document:
    extra_dependencies: ["kotex"]
    fig_height: 6
    fig_width: 10
    toc: yes
    toc_depth: 3
  html_document:
    fig_height: 6
    fig_width: 10
    highlight: textmate
    theme: cosmo
    toc: yes
    toc_depth: 3
    toc_float: yes    
  word_document:
    fig_height: 6
    fig_width: 10
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=T, message=F, warning=F, fig.height = 8, cache=T, dpi = 300, dev = "png")
library(tidyverse)
library(tidymodels)
library(ggplot2)
library(hflights)
```

# dplyr & tidyr


```{r}
df <- mpg
str(df)
nrow(df); ncol(df)
```

## Manipulate variables(columns)

### select(), rename()

```{r}
df.car.info <- select(df, manufacturer, model, year)
```

```{r}
select(df, starts_with(match = "m"))
select(df, contains(match = "r"))
select(df, ends_with(match = "y"))
```

```{r}
select(df, 1:3)
select(df, c(2,5,7))
select(df, 9:11) 
select(df, (ncol(df)-2):ncol(df))
```

```{r}
df1 <- rename(df, mnfc = manufacturer, mod = model)
df1 <- select(df, mnfc = manufacturer, mod = model, everything())
```

### mutate() / transmute()

```{r}
df <- mutate(df, `avg miles per gallon` = (cty + hwy) / 2)
df <- mutate(df,
             car = paste(manufacturer, model, sep = " "),
             `cyl / trans` = paste(cyl, " cylinders", " / ", trans, " transmission", sep = ""))

```

```{r}
df1 <- transmute(df,
                 `avg miles per gallon` = (cty + hwy) / 2)
df1

df2 <- mutate(df,
             car = paste(manufacturer, model, sep = " "),
             `cyl / trans` = paste(cyl, " cylinders", " / ", trans, " transmission", sep = ""))
df2

df2 <- transmute(df,
             car = paste(manufacturer, model, sep = " "),
             `cyl / trans` = paste(cyl, " cylinders", " / ", trans, " transmission", sep = ""))
df2
```

## Manipulate variables(row)

### filter(), slice()

```{r}
filter(df, manufacturer == "audi") 
```

```{r}
filter(df, manufacturer == "audi" & year == 1999) 
```

```{r}
df1 <- filter(df, manufacturer == "audi" | manufacturer == "dodge")
df2 <- filter(df, manufacturer %in% c("audi", "dodge")) 
```

```{r}
filter(df, hwy >= 30)
```
```{r}
filter(df, year != 1999)
```
```{r}
slice(df, 1:5)
```

```{r}
slice(df, 20:30)
```
```{r}
slice(df, (nrow(df)-9):nrow(df))
```


### arrange

```{r}
# Sort rows by year (ascending order)
arrange(df, year)
```

```{r}
# Sort rows by year (descending order)
arrange(df, desc(year))
```

```{r}
# Sort rows by year (ascending order), cyl and displ
df.sort <- arrange(df, year, cyl, displ)
df.sort
```


### distinct
```{r}
df.example <- data.frame(id = 1:3, name = c("John", "Max", "Julia"))
df.example <- bind_rows(df.example, slice(df.example, 2)) # create duplicate of 2nd row
df.example <- arrange(df.example, id)
df.example
```


```{r}
# show table without duplicates
distinct(df.example)
```

```{r}
#  Back to mpg example - lets create a table with duplicates
df.dupl <- select(df, manufacturer, model)
df.dupl
```
```{r}
#   Keep only unique rows without duplicates
df.nodupl <- distinct(df.dupl)
df.nodupl
```
### Sample rows

```{r}
# sample_n() - Filter n randomly selected rows 
set.seed(42)
```

```{r}
# 10 randomly selected rows without replacement
sample_n(df, size = 10, replace = F)
```

```{r}
# 10 randomly selected rows with replacement
sample_n(df, size = 10, replace = T)
```

```{r}
# sample_frac() - Filter a fraction of randomly selected rows 
# 10% of table rows randomly selected
sample_frac(df, size = 0.1, replace = F)
```

### summarise
```{r}
# Calculate average hwy
summarise(df, `mean hwy` = mean(hwy))
```

```{r}
# Count table rows, and count distinct car models
summarise(df, rows = n(), `nr models` = n_distinct(model))
```

```{r}
# Calculate min / max hwy & cty
summarise(df, 
          `min hwy` = min(hwy),
          `min cty` = min(cty),
          `max hwy` = max(hwy),
          `max cty` = max(cty))
```

### group_by()

```{r}
# Group cars by manufacturer
group_by(df, manufacturer)
```

```{r}
# Combine summarise() & group_by() - summary statistics for grouped data
# Count number of cars for each manufacturer
summarise(group_by(df, manufacturer), cars = n())
```
```{r}
# Calculate mean / min / max hwy for each model
summarise(group_by(df, model),
          `mean hwy` = mean(hwy),
          `min hwy` = min(hwy),
          `max hwy` = max(hwy))
```

### count()
```{r}
# Count number of table rows
count(df)
```

```{r}
# Count number of cars per model
count(group_by(df, model))
```

## pipe operator `%>%`

```{r}
df %>% 
  filter(manufacturer == "audi") %>% 
  count()
```

```{r}
df %>% 
  filter(manufacturer %in% c("dodge", "chevrolet")) %>% 
  select(manufacturer, model, year, class)
```
```{r}
df %>% 
  group_by(manufacturer, model, class, trans) %>% 
  summarise(`mean hwy` = mean(hwy), cars = n()) %>% 
  ungroup() %>%
  filter(`mean hwy` > 30) %>% 
  arrange(desc(`mean hwy`))
```

## pivoting()

```{r}
table.long <- data.frame(id = 1:6,
                         type = c("a", "b", "a", "c", "c", "a"),
                         count = c(20, 50, 45, 15, 12, 5))
table.long
```

```{r}
table.wide <- pivot_wider(table.long, 
                          names_from = type, 
                          values_from = count)
table.wide
```

```{r}
table.long1 <- pivot_longer(table.wide, 
                            cols = c("a", "b", "c"), 
                            names_to = "type", 
                            values_to = "count", 
                            values_drop_na = T)
table.long1
```

```{r}
df.long <- df %>% 
  filter(manufacturer %in% c("jeep", "land rover", "hyundai")) %>% 
  select(model, trans, hwy) %>% 
  group_by(model, trans) %>% 
  summarise(`mean hwy` = mean(hwy)) %>% 
  ungroup()
df.long
```

```{r}
df.wide <- df.long %>% 
  pivot_wider(names_from = trans, 
              values_from = `mean hwy`)
df.wide
```

```{r}
df.long1 <- df.wide %>% 
  pivot_longer(-model,  # exclude column "model" and use all remaining columns!!!
               names_to = "trans", 
               values_to = "mean hwy", 
               values_drop_na = T)
df.long1
```


## separating and uniting

```{r}
dates <- seq.Date(from = as.Date("2021-01-01"), to = as.Date("2021-12-31"), by = "day") # generate dates
table <- data.frame(date = dates)
table %>% head(); table %>% tail()
```

### separate()
```{r}
table.sep <- table %>% 
  separate(data = ., 
           col = date, 
           into = c("year", "month", "dayofmonth"), 
           sep = "-") %>% 
  mutate(month = as.numeric(month),
         dayofmonth = as.numeric(dayofmonth)) %>% 
  arrange(year, month, dayofmonth)
table.sep
```

```{r}
table.sep_ <- table %>% 
  separate(data = ., 
           col = date, 
           into = c("year", "month", "dayofmonth"), 
           sep = "-") %>% 
  mutate_at(.tbl = .,                         # which table? - . stands for table in the pipe line!
            .vars = c("month", "dayofmonth"), # which variables are mutated?
            .funs = as.numeric) %>%           # which functions is applied?
  arrange(year, month, dayofmonth)
table.sep_
```

### unite()

```{r}
table.unite <- table.sep %>% 
  # add leading zeros
  mutate(month = str_pad(month, width = 2, side = "left", pad = "0"), # add leading zeros to month
         dayofmonth = str_pad(dayofmonth, width = 2, side = "left", pad = "0")) %>% # add leading zeros to dayofmonth
  unite(data = ., 
        col = "date", 
        year, month, dayofmonth, 
        sep = "-") %>% 
  arrange(date)
table.unite
```

```{r}
table.unite_ <- table.sep %>% 
  # add leading zeros
  mutate_at(.tbl = .,                              # which table? - . stands for table in the pipe line!
            .vars = c("month", "dayofmonth"),      # which variables are mutated?
            .funs = str_pad, 2, "left", "0") %>%   # which functions is applied? - function parameters are written down
  unite(data = ., 
        col = "date", 
        year, month, dayofmonth, 
        sep = "-") %>% 
  arrange(date)
table.unite_
```

## dplyr and tidyr in action

### pull() - extract column as vector

```{r}
df %>% pull(hwy)
df %>% pull(hwy) %>% class()
df %>% select(hwy) %>% class()
```

### group_by() + mutate()
```{r}
df <- df %>% 
  group_by(manufacturer, model) %>% 
  mutate(`mean hwy` = mean(hwy)) %>% 
  ungroup()
df
```


### case_when() - case when statements
```{r}
df <- df %>% 
  mutate(trans_ = str_sub(string = trans, 
                          start = 1, 
                          end = 1)) %>%  # extract first letter from trans
  mutate(`transmission type` = case_when(trans_ == "a" ~ "automatic",
                                         trans_ == "m" ~ "manual",
                                         TRUE ~ "NA")) %>% 
  select(-trans_)
df %>% count(`transmission type`, trans)  # check car count
```

### row_number() - add ranks
```{r}
df <- df %>% 
  mutate(`car id` = row_number())
df
```

```{r}
df <- df %>% 
  group_by(manufacturer) %>% 
  mutate(`car id1` = row_number()) %>% 
  ungroup()

```

## Transform table holding flights data

```{r}
df <- hflights
```

### count number of rows/columns, different flights

```{r}
nrow(df); ncol(df)
df %>% 
  count(UniqueCarrier, FlightNum, TailNum, Year, Month, DayofMonth) %>% 
  arrange(desc(n))
# one flight is represented with!: UniqueCarrier, FlightNum, TailNum, Year, Month, DayofMonth
```

### how many columns begin with word "Taxi"?
```{r}
df %>% 
  select(starts_with("Taxi")) %>% 
  head()
```
### how many flights were flown less than 1000 miles / greater or equal than 1000 miles
```{r}
df %>% 
  mutate(dist1000 = case_when(Distance < 1000  ~ "< 1000 miles",
                              Distance >= 1000 ~ ">= 1000 miles")) %>% 
  count(dist1000)
```
### flights per carrier - sort by top to bottom
```{r}
df %>% 
  group_by(UniqueCarrier) %>% 
  count() %>% 
  ungroup() %>% 
  arrange(desc(n))
```
### number of cancelled flights per carrier
```{r}
df %>% count(Cancelled) # 1 for cancelled
df %>% 
  filter(Cancelled == 1) %>% 
  group_by(UniqueCarrier) %>% 
  count() %>% 
  ungroup() %>% 
  arrange(desc(n))
```
### percentage of cancelled flights per carrier
```{r}
df %>% 
  # count flights break down by cancellation
  group_by(UniqueCarrier, Cancelled) %>% 
  count() %>% 
  ungroup() %>% 
  # calculate total flights
  group_by(UniqueCarrier) %>% 
  mutate(`n tot` = sum(n)) %>% 
  ungroup() %>% 
  # calculate percentages
  mutate(`n percent %` = (n / `n tot`) * 100) %>% 
  # keep only cancelled flights - arrange top to bottom
  filter(Cancelled == 1) %>% 
  arrange(desc(`n percent %`))
```

### create column date by combining year + month + dayofmonth (remove this columns)
```{r}
df <- df %>% 
  # add leading zeros to month and dayofmonth
  mutate_at(.vars = c("Month", "DayofMonth"), 
            .funs = str_pad, 2, "left", "0") %>% 
  unite(col = "Date", 
        Year, Month, DayofMonth, 
        sep = "-") 
```
### check date range
```{r}
df %>% 
  summarise(min = min(Date),
            max = max(Date),
            n_distinct = n_distinct(Date))
```
```{r}
# count flights per cancellation codes (codes in columns)
# and per carrirs (carriers in rows)
# pivoting required!!!
df %>% count(CancellationCode) # cancellation code "" must have some name other than empty string!
```
```{r}
df %>% 
  mutate(CancellationCode = case_when(CancellationCode == "" ~ "0",  # this is not cancelled flight!!!
                                      TRUE ~ CancellationCode)) %>% 
  group_by(UniqueCarrier, CancellationCode) %>% 
  count() %>% 
  ungroup() %>% 
  pivot_wider(names_from = CancellationCode, 
              values_from = n)
```
## Column-wise operations: across()

```{r}
mpg <- ggplot2::mpg # mpg data
```

### summarise() & across()

```{r}
#  count distinct values in each column
mpg %>% 
  summarise(across(.cols = everything(), # which columns:   all columns
                   .fns = n_distinct))   # which function:  count distinct/unique values
mpg %>% 
  summarise(across(everything(),
                   n_distinct))
```

```{r}
#  calculate mean values for selected columns (list of columns)
mpg %>% 
  summarise(across(c(displ, cty, hwy), 
                   mean))
```
```{r}
#  calculate median value for all numeric columns
mpg %>% 
  summarise(across(where(is.numeric),   # "where" clause supports conditions for columns selection!
                   median))
```
```{r}
#  calculate distinct values of character columns
mpg %>% 
  summarise(across(where(is.character), 
                   n_distinct))
```
```{r}
#  apply more than one function across multiple columns
#   - calculate mean and median of all numeric columns
mpg %>% 
  summarise(across(where(is.numeric), 
                   list(avg = ~mean(.x, na.rm = T),     # multiple functions: provided as a list of functions!
                        med = ~median(.x, na.rm = T))))
```

```{r}
avgmed <- list(avg = ~mean(.x, na.rm = T),   
               med = ~median(.x, na.rm = T))
mpg %>% 
  summarise(across(where(is.numeric), 
                   avgmed)) 
```
```{r}
#  control names of output columns
mpg %>% 
  summarise(across(where(is.numeric), 
                   avgmed, 
                   .names = "{.fn}:{.col}")) # argument used for column name control
```
```{r}
#  use multiple conditions for column selection 
mpg %>% 
  summarise(across(where(is.numeric) & ends_with("y"),
                   median))
```

### summarise() ~ group_by() & across()
```{r}
#  calculate sum of all numeric columns break down by car model
mpg %>% 
  group_by(model) %>% 
  summarise(across(where(is.numeric), 
                   sum)) %>% 
  ungroup()
```
```{r}
# calculate mean value for selected columns break down by car manufacturer & model
mpg %>% 
  group_by(manufacturer, model) %>% 
  summarise(across(c(displ, cty, hwy),
                   mean)) %>% 
  ungroup()
```

### mutate() & across()

```{r}
#  round up (ceiling) all numeric columns
mpg %>% 
  mutate(across(where(is.numeric),
                ~ceiling(.x)))
```
```{r}
#  convert all character columns to upper case
mpg %>% 
  mutate(across(where(is.character),
                ~str_to_upper(.x)))
```

### mutate() ~ group_by() & across()

```{r}
#  calculate mean value for all numeric columns break down by car manufacturer
#   - aggregate mean value of numeric columns for each manufacturer
#   - keep all the rows!
mpg %>% 
  group_by(manufacturer) %>% 
  mutate(across(where(is.numeric) & -year, # column "year" is removed from calculation!
                ~mean(.x, na.rm = T), 
                .names = "{.col}_avg_manufacturer")) %>% 
  ungroup()
```

```{r}
# if_any() / if_all() with filter()
#
# if_any() : keeps the rows where the predicate is true for at least one selected column
#
# if_all() : keeps the rows where the predicate is true for all selected columns
starwars <- dplyr::starwars # star wars data set
?starwars
```

```{r}
#  filter rows where at least one column doesn't have NA value
starwars %>% 
  filter(if_any(.cols = everything(), 
                .fns = ~ !is.na(.x)))
```

```{r}
#  filter rows where all columns don't have NA value
starwars %>% 
  filter(if_all(.cols = everything(), 
                .fns = ~ !is.na(.x)))
```

```{r}
#  filter rows where column "cty" or "hwy" have values greater than 20
mpg %>% 
  filter(if_any(c(cty, hwy), 
                ~ . > 20)) # condition written as function
```

```{r}
#  filter rows where column "cty" and "hwy" have values greater than 20
mpg %>% 
  filter(if_all(c(cty, hwy), 
                ~ . > 20)) 
```

