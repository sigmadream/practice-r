---
title: "고급 시각화 - (ggplot2)를 중심으로"
author: "Sangkon Han(sangkon@pusan.ac.kr)"
date: "`r format(Sys.Date())`" 
output:
  pdf_document:
    extra_dependencies: ["kotex"]
    fig_height: 6
    fig_width: 10
    toc: no    
  html_document:
    fig_height: 6
    fig_width: 10
    highlight: textmate
    theme: cosmo
    toc: yes
    toc_depth: 3
    toc_float: yes    
  word_document:
    fig_height: 6
    fig_width: 9
    toc: no  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=T, message=F, warning=F, cache=T, fig.align = "center", fig.height = 8, dpi = 300, dev = "png")
```

```{r}
install.packages("lattice", repos = "https://cran.us.r-project.org")
install.packages("mlmRev", repos = "https://cran.us.r-project.org")
install.packages("ggplot2", repos = "https://cran.us.r-project.org")
```

# 패키지 설치 및 데이터 준비

`lattice`과 `mlmRev`를 활성화하세요.
```{r}
library(lattice)
library(mlmRev)
```

해당 데이터를 불러옵니다.
```{r}
data("Chem97")
```

먼저 데이터의 구성을 확인합니다.
```{r}
str(Chem97)
```

데이터의 앞부분 30개를 살펴보겠습니다.
```{r}
head(Chem97, 30)
```

## 간단한 그래프 작성

`lattice`는 간단한 직교형태의 그래픽을 구성하는 방법을 포함하고 있습니다. `R`에서 제공하는 것과 별도로 작동하며, 데이터 셋의 특징을 전반적으로 보여주는 것이 주요한 특징입니다.

### 히스토그래프

`histogram()` 함수를 이용하여 데이터 시각화를 시작해보겠습니다.
```{r}
histogram(~gcsescore, data = Chem97)
```

`score` 변수를 **조건**변수로 지정하여 데이터를 시각화하는 방법은 아래와 같습니다. score 변수를 사용하면 주황색 기준으로 격자형으로 분리해서 분포를 보여줍니다. 하지만 해당 주황색의 값을 정확하게 알기 쉽지 않습니다.
```{r}
histogram(~gcsescore | score, data = Chem97)
```

`factor`를 사용하여 `score` 값을 손쉽게 확인할 수 있습니다. factor는 범주 값을 반환하는 것으로(0~10) score를 x축에 대입하면, 순서대로 적용됩니다.
```{r}
histogram(~gcsescore | factor(score), data = Chem97)
```

### 밀도 그래프

선을 그려서 값을 표현하는 형태로 `R`에서 제공하는 `line`과 유사한 기능입니다. 분포를 빠르게 이해하는데 표율적입니다.
- `plot.points`는 밀도 점 표시
- `auto.key`는 범례 표시 여부
```{r}
densityplot(~gcsescore | factor(score), data = Chem97, groups = gender, plot.Points = T, auto.ley = T)
```

### 막대 그래프

`VADeaths` 데이터를 사용하도록 하겠습니다.
```{r}
data(VADeaths)
```

해당 데이터는 `matrix`로 구성되어 있습니다.
```{r}
head(VADeaths)
str(VADeaths)
```

matrix 형식을 `table` 형식으로 변경합니다.
```{r}
dft <- as.data.frame.table(VADeaths)
str(dft)
```
막대 그래프를 그려줍니다. `Var2`를 기준으로 막대 그래프를 그려주며, `c(4,1)`는 4개를 1개의 행에 출력하라는 의미입니다. 4행 1열로 이해하지 않도록 주의를 해야 합니다. 
```{r}
barchart(Var1 ~ Freq | Var2, data = dft, layout = c(4, 1), origin = 0 )
```
### 점 그래프
1점 그래는 아래와 같은 형태로 사용할 수 있습니다.
```{r}
dotplot(Var1 ~ Freq | Var2, dft, layout = c(4,1))
```

`Var2` 변수 단위로 그룹화하여 점을 연결하는 것을 지원하며, 산점도 타입(`type`)과 범례(`auto.key`)를 추가하여 아래와 같은 형태로 작성할 수 있습니다.
```{r}
dotplot(Var1 ~ Freq, data = dft, groups = Var2, type = "o", auto.key = list(space = "right", points = T, lines = T))
```

### 산점도 그래프

```{r}
library(datasets)
str(airquality)
```

점 그래프와 마찬가지로, 간단한 산점도 그래프는 아래와 같은 형태로 작성할 수 있습니다.
```{r}
xyplot(Ozone ~ Wind, data = airquality)
```

월별로 산점도 그래프를 그릴 수 있습니다.

```{r}
xyplot(Ozone ~ Wind | factor(Month), data = airquality, layout=c(5,1))
```

```{r}
str(quakes)
```

```{r}
xyplot(lat ~ long, data = quakes, pch = ".")
```

```{r}
tplot <- xyplot(lat ~ long, data = quakes, pch = ".")
tplot <- update(tplot, main = "1964년 이후 태평양에서 발생한 지진 위치")
print(tplot)
```

```{r}
quakes$depth2[quakes$depth >= 40 & quakes$depth <= 150] <- 1
quakes$depth2[quakes$depth >= 151 & quakes$depth <= 250] <- 2
quakes$depth2[quakes$depth >= 251 & quakes$depth <= 350] <- 3
quakes$depth2[quakes$depth >= 351 & quakes$depth <= 450] <- 4
quakes$depth2[quakes$depth >= 451 & quakes$depth <= 550] <- 5
quakes$depth2[quakes$depth >= 551 & quakes$depth <= 680] <- 6
convert <- transform(quakes, depth2 = factor(depth2))
xyplot(lat ~ long | depth2, data = convert)
```

```{r}
xyplot(Ozone + Solar.R ~ Wind | factor(Month), data = airquality, col = c("blue", "red"), layout = c(5, 1))
```

### 데이터 범주화
`equal.count`를 사용하면 데이터를 범주화 할 수 있습니다. `numgroup`은 1 ~ 150을 대상으로 겹치지 않게 4개 영역으로 범주화하는 방식을 보여주는 것으로 `depthgroup`은 지진 데이터를 5개의 영역으러 범주화 합니다.
```{r}
numgroup <- equal.count(1:150, number = 4, overlap = 0)
depthgroup <- equal.count(quakes$depth, number = 5, overlap = 0)
xyplot(lat ~ long | depthgroup, data = quakes, main = "Fiji Earthquakes(depthgroup)", ylab = "latitude", xlab = "longitude", pch = "@", col = "red")
```

수심과 리히터 규모를 동시에 표현하는 방법(`depthgroup * magnitudegroup`)은 아래와 같습니다. 

```{r}
magnitudegroup <- equal.count(quakes$mag, number = 2, overlap =0)
xyplot(lat ~ long | depthgroup * magnitudegroup, data = quakes, main = "Fiji Earthquakes", ylab = "latitude", xlab = "longitude", pch = "@", col = c("red", "blue"))
```


## ggplot2 그래프

`ggplot2`는 그래프를 만들 때 사용하는 패키지로 'layer' 구조로 되어 있습니다. (layer 구조 - 기본 + 옵션1 + 옵션2 ) 방식으로 쌓아올리는 형식을 사용합니다. 일반적으로 간단하게 시각화 하고 싶을 때 사용합니다.
- 기본(x,y축 설정) + 옵션1(그래프 유형선택 - 점, 선, 막대) + 옵션2 (색상, 표식 등등)
- 기하학적 객체들(점,선,막대등)에 미적특성(색상, 모양,크기)을 설정하여 플로팅
- 그래픽 생성 기능과 통계 변환을 포함
- ggplot2의 기본함수 qplot()-aesthetics(크기,모양,색상)과 geoms(점,선등) 으로 구성


```{r}
library(ggplot2)
str(mpg)
```

```{r}
summary(mpg)
```

```{r}
table(mpg$drv)
```

### 막대 그래프
`fill`은 막대 그래프 상에서 색상으로 구별하여 시각화하는 것으로 변수에 대한 특징이 가시적으로 확인 가능합니다. `binwidth`는 막대의 폭 크기를 지정합니다. `facets`는 열 단위로 패널을 생성할 수 있습니다. 행단위로 보고 싶으시면 `facets = drv~.`로 구성하시면 됩니다.
```{r}
qplot(hwy, data = mpg, fill = drv, binwidth = 2, facets = .~drv)
```

### 산점도 그래프
mpg 데이터 셋의 displ 과 hwy 변수 이용하여 산점도를 그려줍니다.
```{r}
qplot(displ, hwy, data=mpg, color = drv, facets = .~drv)
```

```{r}
qplot(wt,mpg, data=mtcars, color=factor(carb), size=qsec, shape=factor(cyl))
```

```{r}
qplot(clarity, data=diamonds, fill=cut, geom = "bar") # 레이아웃에 색 채우기
```

```{r}
qplot(wt,mpg, data=mtcars, color=factor(carb), size=factor(cyl), geom = "point")
```



















